# سیستم عضویت اجباری در کانال

## 🎯 هدف

این سیستم تضمین می‌کند که کاربران قبل از استفاده از ربات، حتماً در کانال مشخص شده عضو شوند.

## 📋 ویژگی‌ها

- ✅ **چک کردن عضویت**: بررسی خودکار عضویت کاربر در کانال
- ✅ **پیام راهنما**: راهنمایی کامل برای عضویت در کانال
- ✅ **دکمه عضویت**: دکمه مستقیم برای عضویت در کانال
- ✅ **تأیید عضویت**: دکمه تأیید پس از عضویت
- ✅ **مسدود کردن دسترسی**: عدم دسترسی به ربات بدون عضویت

## 🔧 تنظیمات

### Configuration (config.yaml)
```yaml
telegram:
  mandatory_channel_id: -1001976057034  # ID کانال اجباری
  mandatory_channel_username: "@hoseinmehri_ir1"  # Username کانال
```

### کانال مورد نظر
- **ID**: `-1001976057034`
- **Username**: `@hoseinmehri_ir1`
- **Name**: `حسین مهریvip`

## 🚀 نحوه کارکرد

### 1. ورود کاربر به ربات
```
کاربر: /start
ربات: [چک کردن عضویت در کانال]
```

### 2. اگر کاربر عضو نباشد
```
ربات: 🔔 عضویت در کانال

برای استفاده از ربات، ابتدا باید در کانال زیر عضو شوید:

📢 کانال: @hoseinmehri_ir1

مراحل عضویت:
1️⃣ روی دکمه "📢 عضویت در کانال" کلیک کنید
2️⃣ در کانال عضو شوید
3️⃣ روی "✅ عضو شدم" کلیک کنید

⚠️ توجه: بدون عضویت در کانال نمی‌توانید از ربات استفاده کنید.

[دکمه عضویت در کانال] [✅ عضو شدم]
```

### 3. اگر کاربر عضو باشد
```
ربات: [ادامه فرآیند عادی ربات]
```

## 🔍 بررسی عضویت

### وضعیت‌های معتبر
- `member`: عضو عادی
- `administrator`: ادمین کانال
- `creator`: سازنده کانال

### وضعیت‌های نامعتبر
- `left`: کانال را ترک کرده
- `kicked`: از کانال اخراج شده
- `restricted`: محدود شده

## 📁 فایل‌های تغییر یافته

### فایل‌های جدید
- `internal/services/channel_service.go` - سرویس مدیریت کانال

### فایل‌های آپدیت شده
- `config.yaml` - اضافه کردن تنظیمات کانال اجباری
- `internal/config/config.go` - آپدیت ساختار کانفیگ
- `internal/handlers/bot_handler.go` - اضافه کردن چک عضویت
- `internal/keyboards/keyboards.go` - اضافه کردن کیبورد عضویت
- `main.go` - اضافه کردن channel service

## 🛠️ پیاده‌سازی

### ChannelService
```go
type ChannelService struct {
    bot    *tgbotapi.BotAPI
    config *config.TelegramConfig
}

// بررسی عضویت کاربر
func (s *ChannelService) IsUserMemberOfMandatoryChannel(userID int64) (bool, error)

// ارسال پیام عضویت اجباری
func (s *ChannelService) SendMandatoryChannelJoinMessage(chatID int64) error
```

### BotHandler
```go
// چک کردن عضویت قبل از هر عملیات
func (h *BotHandler) handleMessage(message *tgbotapi.Message)

// مدیریت دکمه تأیید عضویت
func (h *BotHandler) handleCallbackQuery(callback *tgbotapi.CallbackQuery)
```

## 🔒 امنیت

### محدودیت‌ها
- فقط کاربران عضو در کانال می‌توانند از ربات استفاده کنند
- بررسی مداوم عضویت در هر تعامل
- عدم دسترسی به قابلیت‌های ربات بدون عضویت

### مدیریت خطا
- در صورت عدم دسترسی به API تلگرام، ربات ادامه کار می‌دهد
- ثبت خطاها در لاگ
- پیام‌های راهنما برای کاربر

## 📊 مانیتورینگ

### لاگ‌ها
- ثبت بررسی عضویت کاربران
- ثبت خطاهای API
- آمار کاربران عضو/غیرعضو

### آمار
- تعداد کاربران عضو در کانال
- تعداد تلاش‌های عضویت
- نرخ موفقیت عضویت

## 🎨 UI/UX

### پیام عضویت اجباری
- راهنمایی مرحله‌ای
- دکمه‌های واضح و کاربرپسند
- پیام‌های تأیید و خطا

### کیبوردها
- دکمه عضویت مستقیم در کانال
- دکمه تأیید عضویت
- طراحی ساده و قابل فهم

## 🔮 آینده‌نگری

### بهبودهای پیشنهادی
1. **چند کانال اجباری**: پشتیبانی از چندین کانال
2. **زمان‌بندی عضویت**: محدودیت زمانی برای عضویت
3. **پیام‌های سفارشی**: قابلیت تنظیم پیام‌ها
4. **آمار پیشرفته**: گزارش‌گیری از عضویت‌ها
5. **اعلان‌ها**: اطلاع‌رسانی به ادمین‌ها

### ویژگی‌های فنی
1. **Cache**: کش کردن وضعیت عضویت
2. **Rate Limiting**: محدودیت بررسی عضویت
3. **Retry**: تلاش مجدد برای بررسی ناموفق
4. **Analytics**: تحلیل رفتار کاربران

## ✅ تست

### سناریوهای تست
1. **کاربر عضو**: باید بتواند از ربات استفاده کند
2. **کاربر غیرعضو**: باید پیام عضویت دریافت کند
3. **عضویت پس از پیام**: باید بتواند پس از عضویت استفاده کند
4. **ترک کانال**: باید دوباره پیام عضویت دریافت کند

### تست دستی
```bash
# 1. ربات را اجرا کنید
go run main.go

# 2. با اکانت غیرعضو تست کنید
# 3. عضویت در کانال
# 4. دوباره تست کنید
```

## 📝 نکات مهم

1. **ربات باید ادمین کانال باشد**: برای بررسی عضویت
2. **کانال باید عمومی باشد**: برای دسترسی آسان
3. **تنظیمات صحیح**: ID و username کانال باید درست باشد
4. **تست کامل**: قبل از production تست کنید

## 🎉 نتیجه

سیستم عضویت اجباری حالا:
- ✅ کاربران را مجبور به عضویت در کانال می‌کند
- ✅ راهنمایی کامل ارائه می‌دهد
- ✅ تجربه کاربری خوبی دارد
- ✅ امنیت بالایی دارد
- ✅ قابل تنظیم و توسعه است
