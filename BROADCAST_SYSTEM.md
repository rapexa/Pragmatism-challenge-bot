# سیستم ارسال پیام همگانی (Broadcast System)

## 📢 ویژگی‌های سیستم

سیستم ارسال پیام همگانی به ادمین‌ها این امکان را می‌دهد که پیام‌هایی را به تمام کاربران فعال ربات ارسال کنند. این سیستم شامل ویژگی‌های زیر است:

### ✅ پشتیبانی از انواع محتوا
- **متن ساده**: ارسال پیام متنی بدون فایل
- **عکس + کپشن**: ارسال عکس با متن اختیاری
- **ویدیو + کپشن**: ارسال ویدیو با متن اختیاری
- **فایل + کپشن**: ارسال فایل با متن اختیاری
- **فایل صوتی + کپشن**: ارسال فایل صوتی با متن اختیاری
- **پیام صوتی**: ارسال پیام صوتی (ویس)
- **استیکر**: ارسال استیکر
- **انیمیشن + کپشن**: ارسال انیمیشن (GIF) با متن اختیاری

### 🔒 سیستم تأیید
- **پیش‌نمایش**: نمایش پیش‌نمایش پیام قبل از ارسال
- **تأیید ادمین**: نیاز به تأیید ادمین قبل از ارسال
- **آمار کاربران**: نمایش تعداد کاربران هدف

### 📊 مدیریت و ردیابی
- **تاریخچه پیام‌ها**: مشاهده تمام پیام‌های ارسال شده
- **آمار ارسال**: تعداد ارسال موفق و ناموفق
- **وضعیت پیام**: ردیابی وضعیت هر پیام (در انتظار، ارسال شده، ناموفق)

## 🏗️ معماری سیستم

### مدل‌های داده

#### BroadcastMessage
```go
type BroadcastMessage struct {
    ID          uint           `gorm:"primarykey"`
    AdminID     int64          `gorm:"not null"`     // ID ادمین ارسال کننده
    ContentType string         `gorm:"not null"`     // نوع محتوا
    Text        string         `json:"text"`         // متن یا کپشن
    FileID      string         `json:"file_id"`      // File ID تلگرام
    FileURL     string         `json:"file_url"`     // URL فایل محلی
    Status      string         `gorm:"default:'pending'"` // وضعیت
    SentCount   int            `gorm:"default:0"`    // تعداد ارسال موفق
    FailedCount int            `gorm:"default:0"`    // تعداد ارسال ناموفق
    CreatedAt   time.Time
    UpdatedAt   time.Time
    DeletedAt   gorm.DeletedAt `gorm:"index"`
}
```

#### BroadcastDelivery
```go
type BroadcastDelivery struct {
    ID           uint           `gorm:"primarykey"`
    BroadcastID  uint           `gorm:"not null"`
    UserID       int64          `gorm:"not null"`    // ID کاربر
    Status       string         `gorm:"not null"`    // وضعیت ارسال
    ErrorMessage string         `json:"error_message"`
    CreatedAt    time.Time
    UpdatedAt    time.Time
    DeletedAt    gorm.DeletedAt `gorm:"index"`
}
```

### سرویس‌ها

#### BroadcastService
- `CreateBroadcast()`: ایجاد پیام همگانی جدید
- `SendBroadcast()`: ارسال پیام به تمام کاربران
- `GetBroadcastHistory()`: دریافت تاریخچه پیام‌ها
- `GetBroadcastStats()`: دریافت آمار پیام
- `GetUserCount()`: تعداد کاربران فعال

### Handler ها

#### AdminHandler
- `sendBroadcastMainMenu()`: نمایش منوی اصلی
- `startBroadcastText()`: شروع ارسال متن
- `startBroadcastPhoto()`: شروع ارسال عکس
- `startBroadcastVideo()`: شروع ارسال ویدیو
- `handleBroadcastContent()`: پردازش محتوای ارسالی
- `showBroadcastPreview()`: نمایش پیش‌نمایش
- `confirmBroadcast()`: تأیید و ارسال
- `cancelBroadcast()`: لغو ارسال

## 🚀 نحوه استفاده

### 1. دسترسی به سیستم
- ادمین دستور `/start` را ارسال می‌کند
- از منوی اصلی گزینه "📢 ارسال پیام همگانی" را انتخاب می‌کند

### 2. انتخاب نوع محتوا
- **📝 ارسال متن**: برای پیام‌های متنی ساده
- **📷 ارسال عکس**: برای عکس با کپشن اختیاری
- **🎥 ارسال ویدیو**: برای ویدیو با کپشن اختیاری
- **📄 ارسال فایل**: برای فایل با کپشن اختیاری
- **🎵 ارسال صدا**: برای فایل صوتی با کپشن اختیاری
- **🎤 ارسال ویس**: برای پیام صوتی
- **😀 ارسال استیکر**: برای استیکر
- **🎬 ارسال انیمیشن**: برای انیمیشن با کپشن اختیاری

### 3. ارسال محتوا
- محتوای مورد نظر را ارسال کنید
- برای انواع محتوا که کپشن پشتیبانی می‌کنند، کپشن را وارد کنید (اختیاری)

### 4. تأیید و ارسال
- پیش‌نمایش پیام نمایش داده می‌شود
- تعداد کاربران هدف نمایش داده می‌شود
- دکمه "✅ تأیید و ارسال" را کلیک کنید
- یا "❌ لغو" را برای لغو عملیات

### 5. مشاهده آمار
- پس از ارسال، آمار ارسال موفق و ناموفق نمایش داده می‌شود
- از گزینه "📋 تاریخچه پیام‌ها" می‌توانید تاریخچه را مشاهده کنید

## ⚙️ تنظیمات و پیکربندی

### محدودیت‌های ارسال
- **Concurrent Limit**: حداکثر 10 ارسال همزمان
- **Rate Limiting**: محدودیت سرعت ارسال برای جلوگیری از محدودیت تلگرام

### مدیریت خطا
- **Retry Mechanism**: تلاش مجدد برای ارسال ناموفق
- **Error Logging**: ثبت خطاهای ارسال
- **Status Tracking**: ردیابی وضعیت هر ارسال

## 🔧 توسعه و سفارشی‌سازی

### اضافه کردن نوع محتوای جدید
1. نوع محتوا را به `BroadcastPreview` اضافه کنید
2. متد ارسال مربوطه را در `BroadcastService` پیاده‌سازی کنید
3. handler مربوطه را در `AdminHandler` اضافه کنید
4. keyboard مربوطه را در `keyboards.go` اضافه کنید

### بهبود عملکرد
- **Batch Processing**: پردازش دسته‌ای برای پیام‌های زیاد
- **Queue System**: سیستم صف برای مدیریت بهتر
- **Caching**: کش کردن اطلاعات کاربران

## 📝 مثال‌های استفاده

### ارسال متن ساده
```
1. ادمین: /start
2. انتخاب: 📢 ارسال پیام همگانی
3. انتخاب: 📝 ارسال متن
4. ارسال: "سلام کاربران عزیز! پیام جدیدی داریم..."
5. تأیید: ✅ تأیید و ارسال
```

### ارسال عکس با کپشن
```
1. ادمین: /start
2. انتخاب: 📢 ارسال پیام همگانی
3. انتخاب: 📷 ارسال عکس
4. ارسال: [عکس]
5. کپشن: "تصویر جدید محصول"
6. تأیید: ✅ تأیید و ارسال
```

## 🛡️ امنیت و محدودیت‌ها

- فقط ادمین‌های تأیید شده می‌توانند از سیستم استفاده کنند
- تأیید اجباری قبل از ارسال
- محدودیت تعداد ارسال همزمان
- ثبت کامل عملیات برای audit

## 📊 مانیتورینگ

- آمار ارسال موفق و ناموفق
- تاریخچه کامل پیام‌ها
- ردیابی وضعیت هر کاربر
- گزارش‌گیری از عملکرد سیستم
