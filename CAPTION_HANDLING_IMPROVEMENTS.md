# بهبود مدیریت کپشن در سیستم Broadcast

## 🎯 مشکل شناسایی شده

سیستم قبلی کپشن‌ها را به درستی مدیریت نمی‌کرد:
- کپشن‌های خالی ارسال می‌شدند
- کاربران نمی‌توانستند به راحتی کپشن را رد کنند
- پیش‌نمایش کپشن‌ها واضح نبود

## ✅ راه‌حل‌های پیاده‌سازی شده

### 1. **بهبود مدیریت کپشن خالی**

#### **قبل از تغییر:**
```go
// کپشن خالی ارسال می‌شد
if caption != "" {
    photo.Caption = caption
}
```

#### **بعد از تغییر:**
```go
// کپشن فقط در صورت وجود ارسال می‌شود
if caption != "" {
    photo.Caption = caption
}
// اگر کپشن خالی باشد، هیچ کپشنی ارسال نمی‌شود
```

### 2. **اضافه کردن دکمه رد کردن کپشن**

#### **کیبورد جدید:**
```go
func SkipCaptionKeyboard() tgbotapi.ReplyKeyboardMarkup {
    keyboard := tgbotapi.NewReplyKeyboard(
        tgbotapi.NewKeyboardButtonRow(
            tgbotapi.NewKeyboardButton("⏭ رد کردن کپشن"),
            tgbotapi.NewKeyboardButton("❌ لغو عملیات"),
        ),
    )
    keyboard.ResizeKeyboard = true
    return keyboard
}
```

### 3. **بهبود منطق پردازش کپشن**

#### **کد جدید:**
```go
case "broadcast_photo_caption", "broadcast_video_caption", ...:
    if message.Text == "❌ لغو عملیات" {
        preview.Text = "" // لغو عملیات
    } else if message.Text == "⏭ رد کردن کپشن" {
        preview.Text = "" // رد کردن کپشن
    } else {
        trimmedText := strings.TrimSpace(message.Text)
        if trimmedText == "" {
            preview.Text = "" // متن خالی
        } else {
            preview.Text = trimmedText // کپشن معتبر
        }
    }
```

### 4. **بهبود پیش‌نمایش**

#### **نمایش بهتر کپشن‌ها:**
```go
if preview.HasFile {
    message += "📎 فایل ضمیمه شده است"
    if preview.Text != "" {
        message += "\n📄 کپشن:\n" + preview.Text
    } else {
        message += " (بدون کپشن)"
    }
    message += "\n\n"
}
```

## 🎯 انواع محتوا پشتیبانی شده

### ✅ **عکس (Photo)**
- کپشن اختیاری
- دکمه رد کردن کپشن
- پیش‌نمایش واضح

### ✅ **ویدیو (Video)**
- کپشن اختیاری
- دکمه رد کردن کپشن
- پیش‌نمایش واضح

### ✅ **فایل (Document)**
- کپشن اختیاری
- دکمه رد کردن کپشن
- پیش‌نمایش واضح

### ✅ **فایل صوتی (Audio)**
- کپشن اختیاری
- دکمه رد کردن کپشن
- پیش‌نمایش واضح

### ✅ **پیام صوتی (Voice)**
- بدون کپشن (طبق استاندارد تلگرام)
- مستقیماً به پیش‌نمایش می‌رود

### ✅ **استیکر (Sticker)**
- بدون کپشن (طبق استاندارد تلگرام)
- مستقیماً به پیش‌نمایش می‌رود

### ✅ **انیمیشن (Animation)**
- کپشن اختیاری
- دکمه رد کردن کپشن
- پیش‌نمایش واضح

## 🚀 نحوه استفاده

### **سناریو 1: ارسال با کپشن**
```
1. ادمین: 📷 ارسال عکس
2. ادمین: [ارسال عکس]
3. ربات: "📝 کپشن عکس را وارد کنید (اختیاری)"
4. ادمین: "این عکس زیبا است"
5. ربات: [پیش‌نمایش با کپشن]
6. ادمین: ✅ تأیید و ارسال
```

### **سناریو 2: ارسال بدون کپشن**
```
1. ادمین: 📷 ارسال عکس
2. ادمین: [ارسال عکس]
3. ربات: "📝 کپشن عکس را وارد کنید (اختیاری)"
4. ادمین: ⏭ رد کردن کپشن
5. ربات: [پیش‌نمایش بدون کپشن]
6. ادمین: ✅ تأیید و ارسال
```

### **سناریو 3: لغو عملیات**
```
1. ادمین: 📷 ارسال عکس
2. ادمین: [ارسال عکس]
3. ربات: "📝 کپشن عکس را وارد کنید (اختیاری)"
4. ادمین: ❌ لغو عملیات
5. ربات: [بازگشت به منوی اصلی]
```

## 🔧 ویژگی‌های فنی

### **1. Trim Whitespace**
- حذف فضاهای اضافی از ابتدا و انتهای کپشن
- تشخیص کپشن‌های خالی

### **2. State Management**
- مدیریت صحیح state های مختلف
- تمایز بین رد کردن کپشن و لغو عملیات

### **3. User Experience**
- دکمه‌های واضح و کاربرپسند
- پیام‌های راهنما
- پیش‌نمایش دقیق

### **4. Error Handling**
- مدیریت خطاهای ورودی
- پیشگیری از ارسال کپشن‌های خالی

## 📊 مقایسه قبل و بعد

| ویژگی | قبل | بعد |
|--------|-----|-----|
| کپشن خالی | ارسال می‌شد | ارسال نمی‌شود |
| رد کردن کپشن | فقط لغو عملیات | دکمه مخصوص |
| پیش‌نمایش | نامشخص | واضح و دقیق |
| User Experience | پیچیده | ساده و کاربرپسند |

## 🎉 نتیجه

سیستم مدیریت کپشن حالا:
- ✅ کپشن‌های خالی ارسال نمی‌کند
- ✅ کاربران می‌توانند به راحتی کپشن را رد کنند
- ✅ پیش‌نمایش واضح و دقیق
- ✅ تجربه کاربری بهتر
- ✅ پشتیبانی از تمام انواع محتوا

## 📁 فایل‌های تغییر یافته

- `internal/handlers/admin_handler.go` - منطق اصلی
- `internal/keyboards/keyboards.go` - کیبورد جدید
- `CAPTION_HANDLING_IMPROVEMENTS.md` - مستندات
