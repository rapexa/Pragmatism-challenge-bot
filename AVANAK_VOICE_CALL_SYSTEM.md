# سیستم تماس صوتی اوانک

## 🎯 هدف

ارسال تماس صوتی خودکار به کاربران بعد از یک دقیقه از ثبت نام با استفاده از سرویس اوانک.

## 📋 ویژگی‌ها

- ✅ **تماس صوتی خودکار**: ارسال تماس بعد از 1 دقیقه از ثبت نام
- ✅ **مدیریت خطا**: مدیریت کامل خطاهای API اوانک
- ✅ **قابلیت فعال/غیرفعال**: امکان خاموش/روشن کردن سرویس
- ✅ **لاگ‌گذاری کامل**: ثبت تمام عملیات و خطاها
- ✅ **Non-blocking**: اجرا در background بدون تأثیر بر عملکرد

## 🔧 تنظیمات

### Configuration (config.yaml)
```yaml
avanak:
  token: "588E620576C8067DB8E40AC8032EF798ED0CA76E"
  message_id: 1000  # کد فایل صوتی
  base_url: "https://portal.avanak.ir/rest/QuickSend"
  enabled: true
```

### پارامترهای اوانک
- **Token**: توکن احراز هویت اوانک
- **MessageID**: کد فایل صوتی (1000)
- **BaseURL**: آدرس API اوانک
- **Enabled**: فعال/غیرفعال کردن سرویس

## 🚀 نحوه کارکرد

### 1. ثبت نام کاربر
```
کاربر: [ثبت نام کامل]
ربات: [ارسال SMS + ویدیو + اطلاعات پشتیبان]
```

### 2. تماس صوتی (بعد از 1 دقیقه)
```
[1 دقیقه بعد]
سیستم: [ارسال تماس صوتی به شماره کاربر]
```

### 3. مدیریت خطا
```
اگر تماس موفق باشد:
✅ Voice call sent successfully to user 123456789 (09123456789)

اگر خطا باشد:
❌ Avanak error for 09123456789: عدم موجودی کافی (code: -3)
```

## 🔍 API اوانک

### درخواست
```http
POST https://portal.avanak.ir/rest/QuickSend
Authorization: 588E620576C8067DB8E40AC8032EF798ED0CA76E
Content-Type: application/x-www-form-urlencoded

MessageID=1000&Number=09123456789&Vote=false&ServerID=0
```

### پاسخ موفق
```json
{
  "ReturnValue": 12345
}
```

### پاسخ خطا
```json
{
  "ReturnValue": -3
}
```

## 📊 کدهای خطا

| کد | توضیحات |
|----|---------|
| -25 | ثبت ارسال سریع غیرفعال میباشد |
| -2 | شماره اشتباه میباشد |
| -3 | عدم موجودی کافی |
| -6 | زمان ارسال غیرمجاز میباشد |
| -8 | کد فایل صوتی اشتباه میباشد |
| -71 | مدت ضبط صدا غیرمجاز میباشد |
| -72 | عدم مجوز ضبط صدا |

## 📁 فایل‌های تغییر یافته

### فایل‌های جدید
- `internal/services/avanak_service.go` - سرویس اوانک

### فایل‌های آپدیت شده
- `config.yaml` - تنظیمات اوانک
- `internal/config/config.go` - ساختار کانفیگ
- `internal/services/delayed_message_service.go` - اضافه کردن تماس صوتی
- `internal/handlers/bot_handler.go` - فعال‌سازی تماس صوتی
- `main.go` - اضافه کردن سرویس اوانک

## 🛠️ پیاده‌سازی

### AvanakService
```go
type AvanakService struct {
    config *config.AvanakConfig
}

// ارسال تماس صوتی
func (s *AvanakService) SendVoiceCall(phoneNumber string) error

// بررسی فعال بودن سرویس
func (s *AvanakService) IsEnabled() bool
```

### DelayedMessageService
```go
// برنامه‌ریزی تماس صوتی بعد از ثبت نام
func (s *DelayedMessageService) ScheduleVoiceCallAfterRegistration(userID int64, phoneNumber string)
```

## 🔒 امنیت

### محدودیت‌ها
- فقط کاربران ثبت‌نام شده تماس دریافت می‌کنند
- تأخیر 1 دقیقه‌ای برای جلوگیری از spam
- مدیریت خطاهای API

### مدیریت خطا
- ثبت کامل خطاها در لاگ
- ادامه کار سیستم در صورت خطای تماس
- پیام‌های واضح برای debugging

## 📊 مانیتورینگ

### لاگ‌ها
- ثبت ارسال موفق تماس‌ها
- ثبت خطاهای API اوانک
- آمار تعداد تماس‌های ارسال شده

### Metrics
- تعداد تماس‌های موفق
- نرخ خطا
- زمان متوسط ارسال

## 🎨 UI/UX

### تجربه کاربری
- تماس صوتی بدون تأخیر در ربات
- عدم نمایش پیام اضافی
- تماس فقط برای کاربران جدید

### مدیریت
- قابلیت فعال/غیرفعال کردن
- تنظیم کد فایل صوتی
- مدیریت توکن اوانک

## 🔮 آینده‌نگری

### بهبودهای پیشنهادی
1. **چند فایل صوتی**: پشتیبانی از فایل‌های مختلف
2. **زمان‌بندی**: تنظیم زمان‌های مختلف
3. **Retry mechanism**: تلاش مجدد برای خطاها
4. **Analytics**: آمارگیری از تماس‌ها
5. **A/B Testing**: تست فایل‌های مختلف

### ویژگی‌های فنی
1. **Queue system**: سیستم صف برای تماس‌ها
2. **Rate limiting**: محدودیت تعداد تماس
3. **Caching**: کش کردن تنظیمات
4. **Monitoring**: مانیتورینگ پیشرفته

## ✅ تست

### سناریوهای تست
1. **کاربر جدید**: باید تماس صوتی دریافت کند
2. **کاربر قدیمی**: نباید تماس دریافت کند
3. **خطای API**: باید خطا ثبت شود
4. **سرویس غیرفعال**: نباید تماس ارسال شود

### تست دستی
```bash
# 1. ربات را اجرا کنید
go run main.go

# 2. کاربر جدید ثبت نام کند
# 3. 1 دقیقه صبر کنید
# 4. تماس صوتی باید ارسال شود
```

## 📝 نکات مهم

1. **توکن اوانک**: باید معتبر باشد
2. **کد فایل صوتی**: باید در اوانک تعریف شده باشد
3. **موجودی**: باید موجودی کافی داشته باشید
4. **تست کامل**: قبل از production تست کنید

## 🎉 نتیجه

سیستم تماس صوتی حالا:
- ✅ تماس صوتی خودکار ارسال می‌کند
- ✅ مدیریت خطا دارد
- ✅ قابل تنظیم است
- ✅ عملکرد بهینه دارد
- ✅ قابل مانیتورینگ است
