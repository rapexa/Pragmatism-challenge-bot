# سیستم تماس صوتی اوانک

## 🎯 هدف

ارسال تماس صوتی خودکار به کاربران بعد از یک دقیقه از ثبت نام با استفاده از سرویس اوانک.

## 📋 ویژگی‌ها

- ✅ **تماس صوتی خودکار**: ارسال تماس بعد از 1 دقیقه از ثبت نام
- ✅ **مدیریت خطا**: مدیریت کامل خطاهای API اوانک
- ✅ **قابلیت فعال/غیرفعال**: امکان خاموش/روشن کردن سرویس
- ✅ **لاگ‌گذاری کامل**: ثبت تمام عملیات و خطاها
- ✅ **Non-blocking**: اجرا در background بدون تأثیر بر عملکرد

## 🔧 تنظیمات

### Configuration (config.yaml)
```yaml
avanak:
  token: "588E620576C8067DB8E40AC8032EF798ED0CA76E"
  message_id: 1000  # کد فایل صوتی
  base_url: "https://portal.avanak.ir/rest/QuickSend"
  enabled: true
```

### پارامترهای اوانک
- **Token**: توکن احراز هویت اوانک
- **MessageID**: کد فایل صوتی (1000)
- **BaseURL**: آدرس API اوانک
- **Enabled**: فعال/غیرفعال کردن سرویس

## 🚀 نحوه کارکرد

### 1. ثبت نام کاربر
```
کاربر: [ثبت نام کامل]
ربات: [ارسال SMS + ویدیو + اطلاعات پشتیبان]
```

### 2. تماس صوتی (بعد از 1 دقیقه)
```
[1 دقیقه بعد]
سیستم: [ارسال تماس صوتی به شماره کاربر]
```

### 3. مدیریت خطا
```
اگر تماس موفق باشد:
✅ Voice call sent successfully to user 123456789 (09123456789)

اگر خطا باشد:
❌ Avanak error for 09123456789: عدم موجودی کافی (code: -3)
```

## 🔍 API اوانک

### درخواست
```http
POST https://portal.avanak.ir/rest/QuickSend
Authorization: 588E620576C8067DB8E40AC8032EF798ED0CA76E
Content-Type: application/x-www-form-urlencoded

MessageID=39488781&Number=09123456789&Vote=false&ServerID=0
```

### پاسخ موفق
```json
{
  "QuickSendID": 12345,
  "MessageID": 39488781,
  "MessageLength": 30,
  "CreditDecrease_InSeconds": 30,
  "CreditDecrease_InPulses": 1,
  "CreditDecrease_InPrice": 1000,
  "Status": "Success"
}
```

### پاسخ خطا
```json
{
  "QuickSendID": -6,
  "MessageID": 0,
  "MessageLength": 0,
  "CreditDecrease_InSeconds": 0,
  "CreditDecrease_InPulses": 0,
  "CreditDecrease_InPrice": 0,
  "Status": "Failed"
}
```

## 📊 کدهای خطا

| کد | توضیحات |
|----|---------|
| -25 | ثبت ارسال سریع غیرفعال میباشد |
| -2 | شماره اشتباه میباشد |
| -3 | عدم موجودی کافی |
| -6 | زمان ارسال غیرمجاز میباشد |
| -8 | کد فایل صوتی اشتباه میباشد |
| -71 | مدت ضبط صدا غیرمجاز میباشد |
| -72 | عدم مجوز ضبط صدا |

## 📁 فایل‌های تغییر یافته

### فایل‌های جدید
- `internal/services/avanak_service.go` - سرویس اوانک

### فایل‌های آپدیت شده
- `config.yaml` - تنظیمات اوانک
- `internal/config/config.go` - ساختار کانفیگ
- `internal/services/delayed_message_service.go` - اضافه کردن تماس صوتی
- `internal/handlers/bot_handler.go` - فعال‌سازی تماس صوتی
- `main.go` - اضافه کردن سرویس اوانک

## 🛠️ پیاده‌سازی

### AvanakService
```go
type AvanakService struct {
    config *config.AvanakConfig
}

// ارسال تماس صوتی
func (s *AvanakService) SendVoiceCall(phoneNumber string) error

// بررسی فعال بودن سرویس
func (s *AvanakService) IsEnabled() bool
```

### DelayedMessageService
```go
// برنامه‌ریزی تماس صوتی بعد از ثبت نام
func (s *DelayedMessageService) ScheduleVoiceCallAfterRegistration(userID int64, phoneNumber string)
```

## 🔒 امنیت

### محدودیت‌ها
- فقط کاربران ثبت‌نام شده تماس دریافت می‌کنند
- تأخیر 1 دقیقه‌ای برای جلوگیری از spam
- مدیریت خطاهای API

### مدیریت خطا
- ثبت کامل خطاها در لاگ
- ادامه کار سیستم در صورت خطای تماس
- پیام‌های واضح برای debugging

## 📊 مانیتورینگ

### لاگ‌ها
- ثبت ارسال موفق تماس‌ها
- ثبت خطاهای API اوانک
- آمار تعداد تماس‌های ارسال شده

### Metrics
- تعداد تماس‌های موفق
- نرخ خطا
- زمان متوسط ارسال

## 🎨 UI/UX

### تجربه کاربری
- تماس صوتی بدون تأخیر در ربات
- عدم نمایش پیام اضافی
- تماس فقط برای کاربران جدید

### مدیریت
- قابلیت فعال/غیرفعال کردن
- تنظیم کد فایل صوتی
- مدیریت توکن اوانک

## 🔮 آینده‌نگری

### بهبودهای پیشنهادی
1. **چند فایل صوتی**: پشتیبانی از فایل‌های مختلف
2. **زمان‌بندی**: تنظیم زمان‌های مختلف
3. **Retry mechanism**: تلاش مجدد برای خطاها
4. **Analytics**: آمارگیری از تماس‌ها
5. **A/B Testing**: تست فایل‌های مختلف

### ویژگی‌های فنی
1. **Queue system**: سیستم صف برای تماس‌ها
2. **Rate limiting**: محدودیت تعداد تماس
3. **Caching**: کش کردن تنظیمات
4. **Monitoring**: مانیتورینگ پیشرفته

## 🔧 عیب‌یابی

### مشکل کد خطای -6 (زمان ارسال غیرمجاز)
```
Avanak error for 09301052378: زمان ارسال غیرمجاز میباشد (code: -6)
```

**علل احتمالی:**
1. **زمان‌بندی محدود**: اوانک ممکن است زمان‌های خاصی را برای ارسال مجاز کند
2. **منطقه زمانی**: ممکن است با منطقه زمانی سرور مشکل باشد
3. **محدودیت زمانی**: ممکن است در ساعات خاصی ارسال مجاز نباشد

**راه‌حل‌ها:**
1. **بررسی زمان سرور**: مطمئن شوید سرور در منطقه زمانی درست است
2. **تماس با پشتیبانی اوانک**: برای بررسی محدودیت‌های زمانی
3. **تست در زمان‌های مختلف**: امتحان کردن در ساعات مختلف روز

### تست اتصال
```bash
# اجرای تست مستقل
go run test_avanak.go
```

**⚠️ توجه: تست اتصال حالا تماس واقعی ارسال می‌کند!**

### تست واقعی در startup
```bash
# هر بار ری‌استارت سیستم، تماس تست ارسال می‌شود
go run main.go
```

**لاگ‌های تست:**
```
🔔 شروع تست اتصال اوانک - ارسال تماس واقعی...
🔔 ارسال تماس تست به شماره 09155520952...
✅ تست اتصال اوانک موفق - تماس به 09155520952 ارسال شد
✅ تست اتصال اوانک موفق - تماس تست ارسال شد
```

### لاگ‌های مفید
```
2025/10/12 21:53:14 Testing Avanak connection...
2025/10/12 21:53:14 Avanak test response: {"QuickSendID":-6,"MessageID":0,"MessageLength":0,"CreditDecrease_InSeconds":0,"CreditDecrease_InPulses":0,"CreditDecrease_InPrice":0,"Status":"Failed"}
2025/10/12 21:53:14 Avanak test failed: زمان ارسال غیرمجاز میباشد (code: -6)
```

## ✅ تست

### سناریوهای تست
1. **کاربر جدید**: باید تماس صوتی دریافت کند
2. **کاربر قدیمی**: نباید تماس دریافت کند
3. **خطای API**: باید خطا ثبت شود
4. **سرویس غیرفعال**: نباید تماس ارسال شود

### تست دستی
```bash
# 1. ربات را اجرا کنید
go run main.go

# 2. کاربر جدید ثبت نام کند
# 3. 1 دقیقه صبر کنید
# 4. تماس صوتی باید ارسال شود
```

### تست اتصال API
```bash
# تست مستقل API اوانک
go run test_avanak.go
```

## 📝 نکات مهم

1. **توکن اوانک**: باید معتبر باشد
2. **کد فایل صوتی**: باید در اوانک تعریف شده باشد
3. **موجودی**: باید موجودی کافی داشته باشید
4. **تست کامل**: قبل از production تست کنید
5. **⚠️ تست واقعی**: هر ری‌استارت تماس تست ارسال می‌شود

## 🔧 مدیریت تست

### غیرفعال کردن تست
اگر نمی‌خواهید هر بار تماس تست ارسال شود:

```yaml
# config.yaml
avanak:
  enabled: false  # غیرفعال کردن کل سرویس
```

### تغییر شماره تست
```go
// internal/services/avanak_service.go
testNumber := "09155520952"  // شماره شما
```

### حذف تست از startup
```go
// main.go - کامنت کردن این بخش
// Test Avanak connection with real voice call
// if avanakService.IsEnabled() {
//     log.Printf("🔔 شروع تست اتصال اوانک - ارسال تماس واقعی...")
//     err = avanakService.TestConnection()
//     ...
// }
```

## 🎉 نتیجه

سیستم تماس صوتی حالا:
- ✅ تماس صوتی خودکار ارسال می‌کند
- ✅ مدیریت خطا دارد
- ✅ قابل تنظیم است
- ✅ عملکرد بهینه دارد
- ✅ قابل مانیتورینگ است
