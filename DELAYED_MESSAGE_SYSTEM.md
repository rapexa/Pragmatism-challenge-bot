# سیستم پیام‌های تأخیری (Delayed Message System)

## 📢 ویژگی‌های سیستم

سیستم پیام‌های تأخیری امکان ارسال پیام‌های خودکار با تأخیر زمانی را فراهم می‌کند. این سیستم برای ارسال پیام‌های پیگیری و یادآوری به کاربران استفاده می‌شود.

### ✅ ویژگی‌های پیاده‌سازی شده

#### 1. **پیام پیگیری لینک گروه**
- **زمان تأخیر**: 1 دقیقه بعد از ارسال لینک گروه
- **پیام**: "چــیــشــد گلادیاتور دکمه شیشه ای رو کلیک کردی برا ورود به ربات⁉️"
- **مکان ارسال**: بعد از ارسال اطلاعات پشتیبان و لینک گروه

#### 2. **پیام‌های سفارشی**
- امکان ارسال پیام‌های سفارشی با تأخیر دلخواه
- پشتیبانی از پیام‌های شخصی‌سازی شده
- مدیریت خطا و retry mechanism

#### 3. **پیام‌های خوش‌آمدگویی**
- پیام‌های خوش‌آمدگویی شخصی‌سازی شده
- استفاده از نام کاربر در پیام
- تأخیر قابل تنظیم

## 🏗️ معماری سیستم

### سرویس DelayedMessageService

```go
type DelayedMessageService struct {
    db  *database.Database
    bot *tgbotapi.BotAPI
}
```

#### متدهای اصلی:

##### `ScheduleDelayedMessage(userID, message, delay)`
- ارسال پیام با تأخیر مشخص
- استفاده از goroutines برای non-blocking execution
- مدیریت خطا و logging

##### `ScheduleGroupLinkFollowUp(userID)`
- ارسال پیام پیگیری لینک گروه
- تأخیر ثابت 1 دقیقه
- پیام پیش‌تعریف شده

##### `ScheduleWelcomeFollowUp(userID, userName)`
- ارسال پیام خوش‌آمدگویی شخصی‌سازی شده
- استفاده از نام کاربر
- تأخیر 1 دقیقه

##### `ScheduleCustomDelayedMessage(userID, message, delayMinutes)`
- ارسال پیام سفارشی با تأخیر دلخواه
- تأخیر بر حسب دقیقه
- انعطاف‌پذیری کامل

## 🚀 نحوه استفاده

### 1. پیام پیگیری لینک گروه (خودکار)
این پیام به صورت خودکار بعد از ارسال لینک گروه ارسال می‌شود:

```go
// در bot_handler.go
h.delayedMessageService.ScheduleGroupLinkFollowUp(telegramID)
```

### 2. پیام‌های سفارشی
برای ارسال پیام‌های سفارشی:

```go
// پیام با تأخیر 5 دقیقه
delayedMessageService.ScheduleCustomDelayedMessage(
    userID, 
    "پیام سفارشی شما", 
    5
)

// پیام خوش‌آمدگویی
delayedMessageService.ScheduleWelcomeFollowUp(
    userID, 
    "نام کاربر"
)
```

## 📍 مکان‌های ارسال پیام پیگیری

### 1. **ثبت نام اولیه کاربر**
- بعد از ارسال ویدیو آموزشی
- بعد از ارسال اطلاعات پشتیبان
- بعد از ارسال لینک گروه

### 2. **بازگشت کاربران**
- وقتی کاربر مجدداً `/start` می‌زند
- بعد از ارسال مجدد ویدیو و اطلاعات
- بعد از ارسال مجدد لینک گروه

### 3. **هر دو حالت**
- پیام پیگیری در هر دو حالت ارسال می‌شود
- تأخیر یکسان (1 دقیقه)
- پیام یکسان

## ⚙️ تنظیمات و پیکربندی

### تأخیر زمانی
- **پیش‌فرض**: 1 دقیقه
- **قابل تنظیم**: بله
- **واحد**: دقیقه

### مدیریت خطا
- **Logging**: ثبت کامل خطاها
- **Retry**: عدم پیاده‌سازی (می‌توان اضافه کرد)
- **Fallback**: ادامه کار در صورت خطا

### Performance
- **Non-blocking**: استفاده از goroutines
- **Memory efficient**: عدم ذخیره‌سازی state
- **Scalable**: قابلیت ارسال به هزاران کاربر

## 🔧 توسعه و سفارشی‌سازی

### اضافه کردن پیام‌های جدید
1. متد جدید در `DelayedMessageService` اضافه کنید
2. پیام و تأخیر مورد نظر را تعریف کنید
3. در مکان مناسب در `BotHandler` فراخوانی کنید

### تغییر تأخیر زمانی
```go
// تغییر تأخیر از 1 دقیقه به 2 دقیقه
s.ScheduleDelayedMessage(userID, message, 2*time.Minute)
```

### اضافه کردن پیام‌های شرطی
```go
// ارسال پیام بر اساس شرایط خاص
if someCondition {
    delayedMessageService.ScheduleCustomDelayedMessage(userID, message, 1)
}
```

## 📝 مثال‌های استفاده

### مثال 1: پیام پیگیری ساده
```
کاربر: /start
ربات: [ارسال ویدیو + اطلاعات پشتیبان + لینک گروه]
[1 دقیقه بعد]
ربات: چــیــشــد گلادیاتور دکمه شیشه ای رو کلیک کردی برا ورود به ربات⁉️
```

### مثال 2: پیام سفارشی
```go
// ارسال پیام یادآوری بعد از 30 دقیقه
delayedMessageService.ScheduleCustomDelayedMessage(
    userID,
    "یادآوری: لطفاً در چالش شرکت کنید!",
    30
)
```

### مثال 3: پیام خوش‌آمدگویی
```go
// ارسال پیام خوش‌آمدگویی شخصی
delayedMessageService.ScheduleWelcomeFollowUp(
    userID,
    "احمد احمدی"
)
```

## 🛡️ امنیت و محدودیت‌ها

### محدودیت‌های فعلی
- **تأخیر حداکثر**: نامحدود (توصیه: کمتر از 24 ساعت)
- **تعداد پیام‌های همزمان**: نامحدود
- **Memory usage**: کم (بدون ذخیره‌سازی state)

### بهبودهای پیشنهادی
- **Rate limiting**: محدودیت تعداد پیام‌های تأخیری
- **Queue system**: سیستم صف برای مدیریت بهتر
- **Persistence**: ذخیره‌سازی پیام‌های تأخیری در دیتابیس

## 📊 مانیتورینگ

### Logs
- ثبت ارسال موفق پیام‌ها
- ثبت خطاهای ارسال
- آمار تعداد پیام‌های ارسال شده

### Metrics
- تعداد پیام‌های تأخیری فعال
- نرخ موفقیت ارسال
- زمان متوسط تأخیر

## 🔮 آینده‌نگری

### ویژگی‌های پیشنهادی
1. **پیام‌های تکراری**: ارسال پیام در بازه‌های زمانی مشخص
2. **پیام‌های شرطی**: ارسال بر اساس شرایط خاص
3. **Template system**: سیستم قالب برای پیام‌ها
4. **Analytics**: آمارگیری از تأثیر پیام‌های تأخیری
5. **A/B Testing**: تست پیام‌های مختلف

### بهبودهای فنی
1. **Database persistence**: ذخیره‌سازی در دیتابیس
2. **Job queue**: سیستم صف برای پیام‌ها
3. **Retry mechanism**: تلاش مجدد برای ارسال ناموفق
4. **Scheduling**: زمان‌بندی پیچیده‌تر
5. **Monitoring**: مانیتورینگ پیشرفته‌تر
